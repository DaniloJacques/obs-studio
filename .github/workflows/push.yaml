name: Push
run-name: ${{ github.ref_name }} push run ðŸš€
on:
  push:
    paths-ignore:
      - '**.md'
    branches:
      - master
      - 'release/**'
    tags:
      - '*'
permissions:
  contents: write
jobs:
  check-format:
    name: Format ðŸ”
    if: github.ref_name == 'master'
    uses: ./.github/workflows/check-format.yaml
    permissions:
      contents: read

  build-project:
    name: Build ðŸ§±
    uses: ./.github/workflows/build-project.yaml
    secrets: inherit
    permissions:
      contents: read

  compatibility-validation:
    name: Validate Compatibility ðŸ•µï¸
    if: github.ref_name == 'master'
    runs-on: ubuntu-24.04
    permissions:
      checks: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for Changed Files âœ…
        uses: ./.github/actions/check-changes
        id: checks
        with:
          baseRef: ${{ github.event.before }}
          checkGlob: plugins/win-capture/data/*.json

      - name: Check for Invalid Compatibility Data ðŸ“‰
        if: fromJSON(steps.checks.outputs.hasChangedFiles)
        uses: ./.github/actions/compatibility-validator
        with:
          repositorySecret: ${{ github.token }}

  services-validation:
    name: Validate Services ðŸ•µï¸
    if: github.ref_name == 'master'
    runs-on: ubuntu-24.04
    permissions:
      checks: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for Changed Files âœ…
        uses: ./.github/actions/check-changes
        id: checks
        with:
          baseRef: ${{ github.event.before }}
          checkGlob: plugins/rtmp-services/data/*.json

      - name: Check Services JSON Schema ðŸ“‰
        if: fromJSON(steps.checks.outputs.hasChangedFiles)
        uses: ./.github/actions/services-validator
        with:
          repositorySecret: ${{ github.token }}
          runSchemaChecks: true
          runServiceChecks: false

  update-documentation:
    name: Update Documentation ðŸ“–
    if: github.repository_owner == 'obsproject' && (github.ref_name == 'master' || github.ref_type == 'tag')
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for Changed Files âœ…
        if: github.ref_type != 'tag'
        uses: ./.github/actions/check-changes
        id: checks
        with:
          baseRef: ${{ github.event.before }}
          checkGlob: '!(cmake*)'

      - uses: ./.github/actions/generate-docs
        if: github.ref_type == 'tag' || fromJSON(steps.checks.outputs.hasChangedFiles)
        with:
          disableLinkExtensions: ${{ github.ref_type == 'tag' }}

  deploy-documentation:
    name: Deploy Documentation to Cloudflare â˜ï¸
    if: github.repository_owner == 'obsproject' && github.ref_type == 'tag'
    runs-on: ubuntu-24.04
    needs: update-documentation
    defaults:
      run:
        shell: bash
    environment:
      name: cf-pages-deploy
    steps:
      - name: Get Commit Information ðŸ†”
        id: setup
        run: |
          : Get Commit Hash ðŸ†”
          echo "commitHash=${GITHUB_SHA:0:9}" >> $GITHUB_OUTPUT

      - uses: actions/download-artifact@v4
        with:
          name: OBS Studio Docs (No Extensions) ${{ steps.setup.outputs.commitHash }}
          path: docs

      - name: Set Up Redirects ðŸ”„
        run: |
          : Set Up Redirects ðŸ”„
          if [[ "${RUNNER_DEBUG}" ]]; then set -x; fi

          echo "/previous/27.2 https://obsproject.com/docs/27.2 302" >> docs/_redirects
          echo "/previous/:major.:minor https://:major-:minor.${{ vars.CF_PAGES_PROJECT }}.pages.dev 302" >> docs/_redirects

      - name: Publish to Live Page
        uses: cloudflare/wrangler-action@f84a562284fc78278ff9052435d9526f9c718361
        with:
          workingDirectory: docs
          apiToken: ${{ secrets.CF_API_TOKEN }}
          accountId: ${{ secrets.CF_ACCOUNT_ID }}
          command: pages publish . --project-name=${{ vars.CF_PAGES_PROJECT }} --commit-hash='${{ steps.setup.outputs.commitHash }}'

  auto-release:
    name: Auto Release (Tiger Lake) ðŸš€
    if: github.event_name == 'push'
    runs-on: ubuntu-24.04
    needs: build-project
    defaults:
      run:
        shell: bash
    steps:
      - name: Get Metadata ðŸ†”
        id: setup
        run: |
          : Get Metadata ðŸ†”
          if [[ "${RUNNER_DEBUG}" ]]; then set -x; fi
          echo "commitHash=${GITHUB_SHA:0:9}" >> $GITHUB_OUTPUT
          echo "version=$(date +'%-Y-%m-%d')" >> $GITHUB_OUTPUT
          echo "branch=${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT

      - name: Download Build Artifacts ðŸ“¥
        uses: actions/download-artifact@v4

      - name: Prepare Release Files ðŸ“¦
        run: |
          : Prepare Release Files ðŸ“¦
          if [[ "${RUNNER_DEBUG}" ]]; then set -x; fi
          shopt -s extglob

          root_dir="${PWD}"
          commit_hash="${{ steps.setup.outputs.commitHash }}"
          version="${{ steps.setup.outputs.version }}"

          echo '::group::Collecting artifacts'

          # Windows x64
          win_dir="obs-studio-windows-x64-${commit_hash}"
          if [ -d "${win_dir}" ]; then
            for f in "${win_dir}"/*.zip; do
              mv -v "${f}" "${root_dir}/OBS-Studio-TigerLake-${version}-Windows-x64.zip"
            done
          fi

          # Ubuntu x64
          ubuntu_dir="obs-studio-ubuntu-24.04-x86_64-${commit_hash}"
          if [ -d "${ubuntu_dir}" ]; then
            for f in "${ubuntu_dir}"/*.deb; do
              mv -v "${f}" "${root_dir}/OBS-Studio-TigerLake-${version}-Ubuntu-x64.deb"
            done
          fi

          # Ubuntu debug symbols
          ubuntu_dbg_dir="obs-studio-ubuntu-24.04-x86_64-${commit_hash}-dbgsym"
          if [ -d "${ubuntu_dbg_dir}" ]; then
            for f in "${ubuntu_dbg_dir}"/*.ddeb; do
              mv -v "${f}" "${root_dir}/OBS-Studio-TigerLake-${version}-Ubuntu-x64-dbgsym.ddeb"
            done
          fi

          # Sources
          src_dir="obs-studio-ubuntu-24.04-sources-${commit_hash}"
          if [ -d "${src_dir}" ]; then
            for f in "${src_dir}"/*.tar.gz; do
              mv -v "${f}" "${root_dir}/OBS-Studio-TigerLake-${version}-Sources.tar.gz"
            done
          fi

          echo '::endgroup::'

      - name: Generate Checksums ðŸªª
        run: |
          : Generate Checksums ðŸªª
          if [[ "${RUNNER_DEBUG}" ]]; then set -x; fi
          shopt -s extglob nullglob

          echo "### Tiger Lake Optimized OBS Studio" > ${{ github.workspace }}/CHECKSUMS.txt
          echo "" >> ${{ github.workspace }}/CHECKSUMS.txt
          echo "Branch: \`${{ steps.setup.outputs.branch }}\`" >> ${{ github.workspace }}/CHECKSUMS.txt
          echo "Commit: \`${{ steps.setup.outputs.commitHash }}\`" >> ${{ github.workspace }}/CHECKSUMS.txt
          echo "" >> ${{ github.workspace }}/CHECKSUMS.txt
          echo "### Checksums" >> ${{ github.workspace }}/CHECKSUMS.txt
          for file in ${{ github.workspace }}/OBS-Studio-TigerLake-*; do
            echo "    ${file##*/}: $(sha256sum "${file}" | cut -d " " -f 1)" >> ${{ github.workspace }}/CHECKSUMS.txt
          done

      - name: Delete existing release for today ðŸ—‘ï¸
        run: |
          : Delete existing release
          gh release delete "${{ steps.setup.outputs.version }}" --yes --repo ${{ github.repository }} 2>/dev/null || true
          git push origin --delete "refs/tags/${{ steps.setup.outputs.version }}" 2>/dev/null || true
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Create Release ðŸ›«
        uses: softprops/action-gh-release@9d7c94cfd0a1f3ed45544c887983e9fa900f0564
        with:
          draft: false
          prerelease: false
          tag_name: ${{ steps.setup.outputs.version }}
          name: "OBS Studio Tiger Lake ${{ steps.setup.outputs.version }}"
          body_path: ${{ github.workspace }}/CHECKSUMS.txt
          files: |
            ${{ github.workspace }}/OBS-Studio-TigerLake-*.zip
            ${{ github.workspace }}/OBS-Studio-TigerLake-*.deb
            ${{ github.workspace }}/OBS-Studio-TigerLake-*.ddeb
            ${{ github.workspace }}/OBS-Studio-TigerLake-*.tar.gz

