name: Push
run-name: ${{ github.ref_name }} push run ðŸš€
on:
  push:
    paths-ignore:
      - '**.md'
    branches:
      - master
      - 'release/**'
    tags:
      - '*'
permissions:
  contents: write
jobs:
  check-format:
    name: Format ðŸ”
    if: github.ref_name == 'master'
    uses: ./.github/workflows/check-format.yaml
    permissions:
      contents: read

  build-project:
    name: Build ðŸ§±
    uses: ./.github/workflows/build-project.yaml
    secrets: inherit
    permissions:
      contents: read

  compatibility-validation:
    name: Validate Compatibility ðŸ•µï¸
    if: github.ref_name == 'master'
    runs-on: ubuntu-24.04
    permissions:
      checks: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for Changed Files âœ…
        uses: ./.github/actions/check-changes
        id: checks
        with:
          baseRef: ${{ github.event.before }}
          checkGlob: plugins/win-capture/data/*.json

      - name: Check for Invalid Compatibility Data ðŸ“‰
        if: fromJSON(steps.checks.outputs.hasChangedFiles)
        uses: ./.github/actions/compatibility-validator
        with:
          repositorySecret: ${{ github.token }}

  services-validation:
    name: Validate Services ðŸ•µï¸
    if: github.ref_name == 'master'
    runs-on: ubuntu-24.04
    permissions:
      checks: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for Changed Files âœ…
        uses: ./.github/actions/check-changes
        id: checks
        with:
          baseRef: ${{ github.event.before }}
          checkGlob: plugins/rtmp-services/data/*.json

      - name: Check Services JSON Schema ðŸ“‰
        if: fromJSON(steps.checks.outputs.hasChangedFiles)
        uses: ./.github/actions/services-validator
        with:
          repositorySecret: ${{ github.token }}
          runSchemaChecks: true
          runServiceChecks: false

  update-documentation:
    name: Update Documentation ðŸ“–
    if: github.repository_owner == 'obsproject' && (github.ref_name == 'master' || github.ref_type == 'tag')
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for Changed Files âœ…
        if: github.ref_type != 'tag'
        uses: ./.github/actions/check-changes
        id: checks
        with:
          baseRef: ${{ github.event.before }}
          checkGlob: '!(cmake*)'

      - uses: ./.github/actions/generate-docs
        if: github.ref_type == 'tag' || fromJSON(steps.checks.outputs.hasChangedFiles)
        with:
          disableLinkExtensions: ${{ github.ref_type == 'tag' }}

  deploy-documentation:
    name: Deploy Documentation to Cloudflare â˜ï¸
    if: github.repository_owner == 'obsproject' && github.ref_type == 'tag'
    runs-on: ubuntu-24.04
    needs: update-documentation
    defaults:
      run:
        shell: bash
    environment:
      name: cf-pages-deploy
    steps:
      - name: Get Commit Information ðŸ†”
        id: setup
        run: |
          : Get Commit Hash ðŸ†”
          echo "commitHash=${GITHUB_SHA:0:9}" >> $GITHUB_OUTPUT

      - uses: actions/download-artifact@v4
        with:
          name: OBS Studio Docs (No Extensions) ${{ steps.setup.outputs.commitHash }}
          path: docs

      - name: Set Up Redirects ðŸ”„
        run: |
          : Set Up Redirects ðŸ”„
          if [[ "${RUNNER_DEBUG}" ]]; then set -x; fi

          echo "/previous/27.2 https://obsproject.com/docs/27.2 302" >> docs/_redirects
          echo "/previous/:major.:minor https://:major-:minor.${{ vars.CF_PAGES_PROJECT }}.pages.dev 302" >> docs/_redirects

      - name: Publish to Live Page
        uses: cloudflare/wrangler-action@f84a562284fc78278ff9052435d9526f9c718361
        with:
          workingDirectory: docs
          apiToken: ${{ secrets.CF_API_TOKEN }}
          accountId: ${{ secrets.CF_ACCOUNT_ID }}
          command: pages publish . --project-name=${{ vars.CF_PAGES_PROJECT }} --commit-hash='${{ steps.setup.outputs.commitHash }}'

  auto-release:
    name: Auto Release ðŸš€
    if: github.event_name == 'push'
    runs-on: ubuntu-24.04
    needs: build-project
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout ðŸ“¥
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get Metadata ðŸ†”
        id: setup
        run: |
          : Get Metadata ðŸ†”
          if [[ "${RUNNER_DEBUG}" ]]; then set -x; fi
          echo "commitHash=${GITHUB_SHA:0:9}" >> $GITHUB_OUTPUT
          echo "version=$(date +'%-Y-%m-%d')" >> $GITHUB_OUTPUT
          echo "branch=${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT

          # Get commits since last release tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -n "$LAST_TAG" ]; then
            COMMITS=$(git log --oneline "${LAST_TAG}..HEAD" --no-merges 2>/dev/null || echo "No previous tag found")
          else
            COMMITS=$(git log --oneline -10 --no-merges)
          fi
          # Store multiline output
          EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
          echo "commits<<$EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "$EOF" >> $GITHUB_OUTPUT

      - name: Download Build Artifacts ðŸ“¥
        uses: actions/download-artifact@v4

      - name: Prepare Release Files ðŸ“¦
        run: |
          : Prepare Release Files ðŸ“¦
          if [[ "${RUNNER_DEBUG}" ]]; then set -x; fi
          shopt -s extglob

          root_dir="${PWD}"
          commit_hash="${{ steps.setup.outputs.commitHash }}"
          version="${{ steps.setup.outputs.version }}"

          echo '::group::Collecting artifacts'

          # Windows x64 profiles
          for profile_suffix in "-tigerlake" "-zen3" ""; do
            profile_label="${profile_suffix:1}"  # strip leading dash
            profile_label="${profile_label:-baseline}"

            win_dir="obs-studio-windows-x64${profile_suffix}-${commit_hash}"
            if [ -d "${win_dir}" ]; then
              for f in "${win_dir}"/*.zip; do
                mv -v "${f}" "${root_dir}/OBS-Studio-${version}-Windows-x64${profile_suffix}.zip"
              done
            fi
          done

          # Ubuntu x64
          ubuntu_dir="obs-studio-ubuntu-24.04-x86_64-${commit_hash}"
          if [ -d "${ubuntu_dir}" ]; then
            for f in "${ubuntu_dir}"/*.deb; do
              mv -v "${f}" "${root_dir}/OBS-Studio-${version}-Ubuntu-x64.deb"
            done
          fi

          # Ubuntu debug symbols
          ubuntu_dbg_dir="obs-studio-ubuntu-24.04-x86_64-${commit_hash}-dbgsym"
          if [ -d "${ubuntu_dbg_dir}" ]; then
            for f in "${ubuntu_dbg_dir}"/*.ddeb; do
              mv -v "${f}" "${root_dir}/OBS-Studio-${version}-Ubuntu-x64-dbgsym.ddeb"
            done
          fi

          # Sources
          src_dir="obs-studio-ubuntu-24.04-sources-${commit_hash}"
          if [ -d "${src_dir}" ]; then
            for f in "${src_dir}"/*.tar.gz; do
              mv -v "${f}" "${root_dir}/OBS-Studio-${version}-Sources.tar.gz"
            done
          fi

          echo '::endgroup::'

      - name: Generate Release Body ðŸ“
        run: |
          : Generate Release Body ðŸ“
          if [[ "${RUNNER_DEBUG}" ]]; then set -x; fi
          shopt -s extglob nullglob

          cat > ${{ github.workspace }}/RELEASE_BODY.md << 'HEADER'
          ## âš¡ Performance-Optimized OBS Studio

          | Build | Best For | CPU Requirement |
          |-------|----------|-----------------|
          | **`x64`** *(baseline)* | Maximum compatibility | Any x86-64 CPU with AVX2 |
          | **`x64-zen3`** | AMD Ryzen 5000+ | Zen 3 microarchitecture |
          | **`x64-tigerlake`** | Intel 11th Gen+ | AVX-512 support |

          > ðŸ’¡ **Not sure?** Use the **baseline `x64`** build.

          HEADER

          echo "**Branch:** \`${{ steps.setup.outputs.branch }}\`" >> ${{ github.workspace }}/RELEASE_BODY.md
          echo "**Commit:** \`${{ steps.setup.outputs.commitHash }}\`" >> ${{ github.workspace }}/RELEASE_BODY.md
          echo "" >> ${{ github.workspace }}/RELEASE_BODY.md

          echo "### ðŸ“ Commits" >> ${{ github.workspace }}/RELEASE_BODY.md
          echo '```' >> ${{ github.workspace }}/RELEASE_BODY.md
          echo "${{ steps.setup.outputs.commits }}" >> ${{ github.workspace }}/RELEASE_BODY.md
          echo '```' >> ${{ github.workspace }}/RELEASE_BODY.md
          echo "" >> ${{ github.workspace }}/RELEASE_BODY.md

          echo "### ðŸªª Checksums" >> ${{ github.workspace }}/RELEASE_BODY.md
          echo '```' >> ${{ github.workspace }}/RELEASE_BODY.md
          for file in ${{ github.workspace }}/OBS-Studio-*; do
            echo "    ${file##*/}: $(sha256sum "${file}" | cut -d " " -f 1)" >> ${{ github.workspace }}/RELEASE_BODY.md
          done
          echo '```' >> ${{ github.workspace }}/RELEASE_BODY.md

      - name: Delete existing release for today ðŸ—‘ï¸
        run: |
          : Delete existing release
          gh release delete "${{ steps.setup.outputs.version }}" --yes --repo ${{ github.repository }} 2>/dev/null || true
          git push origin --delete "refs/tags/${{ steps.setup.outputs.version }}" 2>/dev/null || true
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Create Release ðŸ›«
        uses: softprops/action-gh-release@9d7c94cfd0a1f3ed45544c887983e9fa900f0564
        with:
          draft: false
          prerelease: false
          tag_name: ${{ steps.setup.outputs.version }}
          name: "OBS Studio ${{ steps.setup.outputs.version }}"
          body_path: ${{ github.workspace }}/RELEASE_BODY.md
          files: |
            ${{ github.workspace }}/OBS-Studio-*.zip
            ${{ github.workspace }}/OBS-Studio-*.deb
            ${{ github.workspace }}/OBS-Studio-*.ddeb
            ${{ github.workspace }}/OBS-Studio-*.tar.gz


